---
title: "Covid Flight Analysis"
author: "Group 2"
date: "4/10/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#put all libraries used in the report here 
library(tidyverse)
library(patchwork)
library(ggplot2)
library(tsibble)
library(tsibbledata)
library(lubridate)
library(feasts)
```
# Guiding Question
What factors affected flight delays between January and June 2020? 

# Introduction and Overview of Data
  This study is exploring factors that contributed to arrival delays in U.S. airline traffic during the beginning of the COVID-19 pandemic. Two two primary data sets were used: the first contains information related to airline flights, flight date, arrival delays, destination state, air time, distance, and flight carrier. The second contains information about COVID-19 cases and deaths by state since the start of the pandemic. 
  Out of 47 variables, 19 were explored based on what was deemed relevant to the guiding question. We also joined the Flights data set with a COVID dataset (by date and state [of departure]) to get access to two more variables, cases and deaths, for a total of 21 variables. 
	Many observations contained “NA” values (roughly 89% of the data) and the “canceled” variable was causing this feature, as the other delay statistics could not pertain to a flight that had never taken off. As these “NA” features were logical, the corresponding rows were kept in the dataset. However, there were some “NA” values in the Flights dataset and the corresponding observations were removed (~0.2% of the data).
	After the removal of incomplete observations, Kolmogorov-Smirnov and Chi-Squared tests were run to confirm that the new data retained the original distribution.

# Data Processing 
```{r data processing, cache = TRUE}
flights <- read.csv("./jantojun2020.csv")
us_states <- read.csv("https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv")
desired_cols <- c(2,3,4,5,6,7,10,13,14,17,18,20,25,28,29,31,36,40,41) # desired columns
names(flights[,desired_cols]) # columns kept
flights2 <- flights[,desired_cols] # dataframe with correct columns
clean_flights0 <- flights2 %>% # correcting column data types
  mutate(DISTANCE = as.double(DISTANCE)) %>% 
  mutate(CANCELLED = as.logical(CANCELLED)) %>%
  mutate(FL_DATE = as.Date(FL_DATE,format = "%m/%d/%y"))
us_states2 <- us_states [,-3] %>% # removing "fips" column and dates after flights dataset
  mutate(date = as.Date(date)) %>%
  subset(date <= max(clean_flights0$FL_DATE)) # dropping data after the latest flight date
length(which(rowSums(is.na(us_states2)) > 0)) # checking number of rows with NA values in data set
# CANCELLED column leaves NA in other columns
clean_flights0_length <- nrow(clean_flights0) # number of rows in dataset
# number of not cancelled flights with missing data
num_na_rows <- length(which(rowSums(is.na(clean_flights0)) > 0 & 
                              clean_flights0$CANCELLED == 0)) 
# share of rows with NA values
share_na <- num_na_rows / clean_flights0_length
# number of fully filled rows
num_filled_rows <- clean_flights0_length - num_na_rows 
# share of rows with missing information
share_na
# number of rows with full information
num_filled_rows
# rows  with missing information
bad_rows <- which(rowSums(is.na(clean_flights0)) > 0 & 
                    clean_flights0$CANCELLED == 0)
# eliminating incomplete rows
clean_flights1 <- clean_flights0[-bad_rows,]
c_clean <- clean_flights1 %>% # non-numeric dates
            select_if(is.double)
# only continuous columns w/ NA values
c_clean0 <- clean_flights0 %>% 
            select_if(is.double) %>%
            mutate(FL_DATE = as.numeric(clean_flights0$FL_DATE)) 
# only continuous columns w/o NA values
c_clean1 <- clean_flights1 %>% 
            select_if(is.double) %>%
            mutate(FL_DATE = as.numeric(clean_flights1$FL_DATE)) 
# only discrete columns w/o NA values
d_clean1 <- clean_flights1 %>% select_if(Negate(is.double))
# only continuous columns w/ NA values (randomly sampled)
sampled_rows <- sample(1:nrow(d_clean1), nrow(d_clean1), replace = FALSE)
d_clean0 <- clean_flights0[sampled_rows,]
new_flights <- cbind(d_clean1, c_clean)
# left join by date and ORIGIN STATE
fulldata <- left_join(new_flights, us_states2, by = c(c("FL_DATE" = "date"), c("ORIGIN_STATE_NM" = "state")))
# removing rows that have cases or deaths as "NA"
num_na_rows <- length(which(is.na(fulldata$cases) == TRUE | is.na(fulldata$deaths) == TRUE)) 
bad_rows <- which(is.na(fulldata$cases) == TRUE | is.na(fulldata$deaths) == TRUE)
fulldata2 <- fulldata[-bad_rows,]
# converting NA values to 0
fulldata3 <- fulldata
fulldata3[is.na(fulldata)] <- 0
fulldata3 <- fulldata3 %>%
  mutate(cases = as.integer(cases)) %>% # making discrete column integer
  mutate(deaths = as.integer(deaths)) # making discrete column integer
head(fulldata3) # NA values are converted to 0
```


# Analysis of Key Variables
```{r random sample, include = FALSE}
#variables jonah works on
slim_data = fulldata3 %>% 
  select(ARR_DELAY, DISTANCE, ORIGIN, ORIGIN_STATE_NM, deaths)
names(slim_data) = tolower(names(slim_data))
#speed up initial plot development by randomly sampling 10% of the population
sample_row_index = sample(1:nrow(slim_data), nrow(slim_data)/10)
fulldata3_copy = fulldata3 #so i can change the col names to lowercase to work with code I have written without messing up others code
names(fulldata3_copy) = tolower(names(fulldata3_copy))
#slim_sample is now the full data so plots represent all data
slim_sample = fulldata3_copy #slim_data[sample_row_index,]  
```

## Arrival Delay and Distance
One might think that longer flights are expected to have longer delays. This turns out not to be true. Arrival delays and flight distance are very weakly correlated, with a spearman correlation coefficient (able to detect non-linear trends) of only -0.022. A scatterplot between these two variables suggests that these variables are relatively unrelated as well. 

```{r arrival delay and distance, cache = TRUE}
no_delay = sum(slim_sample$arr_delay <= 0) / length(slim_sample$arr_delay) 
correlation = cor(slim_sample$arr_delay, slim_sample$distance, method = "spearman")
ggplot(slim_sample, aes(distance, arr_delay)) +
  geom_point() +
  labs(x = "Distance (Miles)",
       y = "Arrival Delay (Minutes)",
       title = "Distance vs Arrival Delay")
```


Alternatively, we can examine boxplots of flight distance grouped by every 1000 miles, and see that the distribution of arrival delays is nearly identical in all cases. Outliers have been removed because they obscure most of the distributions since there are some very high outliers. Note that the third quartile is near zero for every boxplot, meaning that 75% of the flights actually arrive on time or early. 

```{r arrival delay and distance 2, cache = TRUE}
#calculate quantiles to filter out outliers 
iqr =  quantile(slim_sample$arr_delay, 0.75) - quantile(slim_sample$arr_delay, 0.25)
upper_outlier_q = quantile(slim_sample$arr_delay, 0.75) + 1.5 * iqr
lower_outlier_q = quantile(slim_sample$arr_delay, 0.25) - 1.5 * iqr
slim_sample %>% 
  filter(arr_delay <= upper_outlier_q) %>% 
  filter(arr_delay >= lower_outlier_q) %>% 
ggplot(aes(distance, arr_delay)) +
  geom_boxplot(aes(group = cut_width(distance, 1000))) +
  labs(x = "Distance", 
       y = "Arrival Delay",
       title = "Arrival Delay Grouped in 1000 Mile Bins w/o Outliers")
```


## Arrival Delay and Covid Deaths
Arrival delays were compared with covid deaths on that particular day, serving as a proxy for the severity of covid. Even though these data are from near the peak of covid, only 42% of the dates in this range have any covid deaths at all. The Spearman correlation coefficient for arrival delays and deaths is -0.05. A graphical approach with the scatterplot also suggests a weak association.

```{r arrival delay and deaths, cache = TRUE}
death_correlation = cor(slim_sample$arr_delay, slim_sample$deaths, method = "spearman")
zero_death_days = sum(slim_sample$deaths == 0) / length(slim_sample$deaths)
ggplot(slim_sample, aes(deaths, arr_delay)) + 
  geom_point() +
  labs(x = "Covid Related Deaths",
       y = "Arrival Delay",
       title = "Covid Deaths vs Arrival Delay")
```

## Arrival Delay and Origin
One variable that seems to significantly influence arrival delays is the airport the flight originated from. A one way ANOVA test of delay modeled by origin reveals that there are statistically significant differences in arrival delays among airports (p-value = $1*10^{-163}$. The rejection of the null hypothesis is unsurprising as there are 375 airports in the data set. The best and the worst airports to fly from are shown below.

```{r anova origin, cache = TRUE}
#The full data set is too large to run ANOVA on, but running it on a randomly sampled subset reveals that the null is rejected with a pvalue of essentially 0
sample_row_index = sample(1:nrow(slim_data), nrow(slim_data)/10)
slim_sample = slim_data[sample_row_index,] 
model = aov(arr_delay ~ origin, data = slim_sample)
results = anova(model)
```

```{r arrival delay and origin, cache = TRUE}
longest_origin_delays = slim_sample %>% 
  group_by(origin) %>% 
  summarize(mean_delay = mean(arr_delay)) %>% 
  arrange(desc(mean_delay)) %>% 
  head(10)
shortest_origin_delays = slim_sample %>% 
  group_by(origin) %>% 
  summarize(mean_delay = mean(arr_delay)) %>% 
  arrange(desc(mean_delay)) %>% 
  tail(10)
p1 = ggplot(longest_origin_delays) + 
  geom_col(aes(rev(reorder(origin, mean_delay)), mean_delay)) +
  labs(x = "Origin", 
       y = "Mean Delay in Minutes",
       title = "10 Worst Airports to Fly From")
p2 = ggplot(shortest_origin_delays) + 
geom_col(aes(reorder(origin, mean_delay), abs(mean_delay))) +
labs(x = "Origin", 
     y = "Mean Minutes Arrived Early",
     title = "10 Best Airports to Fly From")
 
p1 + p2
```

## Arrival Delay and Number of Flights During the Onset of the COVID-19 Pandemic

We notice a that there is an initial increase in mean delay times during the first month of the COVID-19 pandemic indicated by an upward spike, and that mean delay times dip slightly after the initial spike during the pandemic with greater variation times in some states.

```{r formatting data for time series, cache=TRUE}
slim_data2 = fulldata3 %>% 
  select(ARR_DELAY, FL_DATE, DEST_STATE_NM, cases, MKT_UNIQUE_CARRIER)
names(slim_data2) = tolower(names(slim_data2)) 


group_cols <- c("fl_date", "dest_state_nm")
#group data by date and destination, and summarize mean delays and cases
group_state <- slim_data2 %>%
  group_by(across(all_of(group_cols))) %>%
  summarise(delay_mean_on_given_day = mean(arr_delay),
            cases_mean_on_given_day = mean(cases)) 
group_state <- as.data.frame(group_state) #ungroup for sibble
#tsibble indexed by date 
group_state_ts <- as_tsibble(group_state, key = c("dest_state_nm"))


#group data by date and carrier, and summarize mean delays and cases
group_carrier <- slim_data2 %>%
  group_by(across(all_of(c("fl_date", "mkt_unique_carrier")))) %>%
  summarise(delay_mean_on_given_day = mean(arr_delay),
            cases_mean_on_given_day = mean(cases)) 
group_carrier <- as.data.frame(group_carrier) #ungroup for sibble
#tsibble indexed by date 
group_carrier_ts <- as_tsibble(group_carrier, key = c("mkt_unique_carrier"))


```

```{r Midwest and Western US time series, cache=TRUE, fig.width=12, fig.height=10}
#filter to midwest destination states and dates after March that will have more cases
midwest <- group_state_ts %>%
  filter(dest_state_nm=="Illinois" | dest_state_nm=="Indiana" |
           dest_state_nm=="Iowa" | dest_state_nm=="Kansas" |
           dest_state_nm=="Michigan" | dest_state_nm=="Minnesota" |
           dest_state_nm=="Missouri" | dest_state_nm=="Nebraska" |
           dest_state_nm=="North Dakota" | dest_state_nm=="Ohio" |
           dest_state_nm=="South Dakota" | dest_state_nm=="Wisconsin") 

western <- group_state_ts %>%
  filter(dest_state_nm=="Alaska" | dest_state_nm=="Arizona" |
           dest_state_nm=="California" | dest_state_nm=="Colorado" |
           dest_state_nm=="Hawaii" | dest_state_nm=="Idaho" |
           dest_state_nm=="Montana" | dest_state_nm=="Nevada" |
           dest_state_nm=="New Mexico" | dest_state_nm=="Oregon" |
           dest_state_nm=="Utah" | dest_state_nm=="Washington" |
           dest_state_nm=="Wyoming")

#mean cases per day by midwest destination state (after March 2020)
p1 <- ggplot(midwest%>%filter(fl_date>="2020-03-01")) +
        geom_line(aes(x = fl_date, y = cases_mean_on_given_day, col=dest_state_nm)) +
        scale_fill_hue(l=100) +
        guides(color = guide_legend(override.aes = list(size = 3))) +
        labs(y="Mean cases per day (100,000s)", x="", title = "Midwest States") +
        scale_y_continuous(label = scales::label_number(scale=1/1e5)) +
        scale_color_discrete(name = "destination state") +
        scale_x_date(expand=c(0,0)) +
        theme(axis.title = element_text(size=10),
              legend.position = "bottom")

#mean delay time per day by selected midwest destination state
p2 <- ggplot(midwest) +
        geom_line(aes(x = fl_date, y = delay_mean_on_given_day, col=dest_state_nm)) +
        scale_fill_hue(l=100) +
        guides(color = guide_legend(override.aes = list(size = 3))) +
        labs(y="Mean delay time per day (minutes)", x="") +
        scale_color_discrete(name = "destination state") +
        scale_x_date(expand=c(0,0)) +
        ylim(-20,100) +
        theme(legend.position = "none",
              axis.title = element_text(size=10))

#mean cases per day by western destination state
p3 <- ggplot(western%>%filter(fl_date>="2020-03-01")) +
        geom_line(aes(x = fl_date, y = cases_mean_on_given_day, col=dest_state_nm)) +
        scale_fill_hue(l=100) +
        guides(color = guide_legend(override.aes = list(size = 3))) +
        labs(y="Mean cases per day (in 100,000s)", x="", title = "Western States") +
        scale_y_continuous(label = scales::label_number(scale=1/1e5)) +
        scale_color_discrete(name = "") +
        scale_x_date(expand=c(0,0)) +
        theme(axis.title = element_text(size=10),
              legend.position = "bottom")

#mean delay time per day by western destination state 
p4 <- ggplot(western) +
        geom_line(aes(x = fl_date, y = delay_mean_on_given_day, col=dest_state_nm)) +
        scale_fill_hue(l=100) +
        guides(color = guide_legend(override.aes = list(size = 3))) +
        labs(y="Mean delay time per day (minutes)", x="") +
        scale_x_date(expand=c(0,0)) +
        ylim(-20,100) +
        theme(legend.position = "none",
              axis.title = element_text(size=10))
(p1 / p2) | (p3/p4)
```

To test whether delays during the pandemic were significantly different than previously, we split the data by date at the point 2020-03-11. A Kolmogorov-Smirnov test to test whether the distributions of delays per day are significantly different pre-pandemic and during the pandemic reveals that delays are in fact different ($p<<0.05$). Mean delay time per day pre-pandemic ($-0.53 \pm 12.80$) was greater than mean delay time per day ($-7.88 \pm 9.61$) during the pandemic. 

```{r k-s test, cache=TRUE}
pre_pandemic <- group_state_ts %>%
  filter(fl_date < "2020-03-11")

pandemic <- group_state_ts %>%
  filter(fl_date >= "2020-03-11")

mean(pre_pandemic$delay_mean_on_given_day) #mean delay time pre-pandemic
sd(pre_pandemic$delay_mean_on_given_day)
mean(pandemic$delay_mean_on_given_day) #mean delay time pandemic
sd(pandemic$delay_mean_on_given_day)

#Kolmogorov-Smirnov test for difference in distributions of mean delays per day for pre-pandemic and pandemic flights
ks.test(pre_pandemic$delay_mean_on_given_day, pandemic$delay_mean_on_given_day)

```

California has the top 10 number of flights per day, and 8 of these dates are just before or just after March 11, 2020.

```{r number of flights time series, cache=TRUE, fig.height=5, fig.width=8}
#count number of flights per day for each destination state
number_flights <- slim_data2 %>%
  group_by(dest_state_nm) %>%
  count(fl_date, sort=TRUE)

most_flights <- number_flights[0:10,] #CA has 10 of the top 10 number of flight days by state

number_flights_ts <- slim_data2 %>%
  group_by(dest_state_nm) %>%
  count(fl_date, sort=TRUE) %>%
  as.data.frame() %>%
  as_tsibble(key="dest_state_nm")

#just looking at western states again since California has the most flights
western_no <- number_flights_ts %>%
  filter(dest_state_nm=="Alaska" | dest_state_nm=="Arizona" |
           dest_state_nm=="California" | dest_state_nm=="Colorado" |
           dest_state_nm=="Hawaii" | dest_state_nm=="Idaho" |
           dest_state_nm=="Montana" | dest_state_nm=="Nevada" |
           dest_state_nm=="New Mexico" | dest_state_nm=="Oregon" |
           dest_state_nm=="Utah" | dest_state_nm=="Washington" |
           dest_state_nm=="Wyoming")

ggplot(western_no) +
  geom_line(aes(x = fl_date, y = n, col=dest_state_nm)) +
  scale_fill_hue(l=100) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y="Number of flights", x="", title="Number of flights in Western States") +
  scale_x_date(expand=c(0,0)) +
  scale_color_discrete(name = "destination state") +
  theme(legend.position = "bottom",
        axis.title = element_text(size=10))

```
Weighting mean delay per day by number of flights for each destination state, allowed us to more clearly see the dip in delays after the onset of the pandemic. We eliminated Wyoming from this plot of Western states' weighted delays as this state actually has higher mean delay times during the pandemic. 

```{r delays weighted by number of flights, cache=TRUE, fig.height=12, fig.width=8}
avg_delay_w_count <- slim_data2 %>%
  group_by(dest_state_nm) %>%
  add_count(fl_date, sort=TRUE) %>%
  group_by(fl_date, dest_state_nm) %>%
  summarise(mean_delay=mean(arr_delay), n=mean(n)) %>%
  as.data.frame() %>%
  as_tsibble(key="dest_state_nm")

wt_delay_by_no <- avg_delay_w_count %>%
  as.data.frame() %>%
  group_by(fl_date) %>%
  summarise(wt_delay=mean_delay/n, dest_state_nm=dest_state_nm) %>%
  as.data.frame() %>%
  as_tsibble(key="dest_state_nm")

#just looking at western states again since California has the most flights
western_wt_no <- wt_delay_by_no %>%
  filter(dest_state_nm=="Alaska" | dest_state_nm=="Arizona" |
           dest_state_nm=="California" | dest_state_nm=="Colorado" |
           dest_state_nm=="Hawaii" | dest_state_nm=="Idaho" |
           dest_state_nm=="Montana" | dest_state_nm=="Nevada" |
           dest_state_nm=="New Mexico" | dest_state_nm=="Oregon" |
           dest_state_nm=="Utah" | dest_state_nm=="Washington") #|
           #dest_state_nm=="Wyoming")

p1 <- ggplot(western_wt_no) +
    geom_line(aes(x = fl_date, y = wt_delay, col=dest_state_nm)) +
  scale_fill_hue(l=100) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y="Mean delay time per day", x="", title="Mean delay per day (weighted by # of flights) by Western state") +
  scale_x_date(expand=c(0,0)) +
  scale_color_discrete(name = "destination state") +
  theme(legend.position = "bottom",
        axis.title = element_text(size=12))

p2 <- ggplot(wt_delay_by_no %>% filter(dest_state_nm == "Wyoming")) +
    geom_line(aes(x = fl_date, y = wt_delay), col="#FF689F") +
  scale_fill_hue(l=100) +
  guides(color = guide_legend(override.aes = list(size = 3))) +
  labs(y="Mean delay time per day", x="", title="Mean delay per day (weighted by # of flights) Wyoming") +
  scale_x_date(expand=c(0,0)) +
  scale_color_discrete(name = "destination state") +
  theme(legend.position = "none",
        axis.title = element_text(size=12))

p1 / p2
```

## Arrival Delay and Airline Carrier

Finally, we examine delay times per day by airline carrier. There is some variation for the different airline carriers when we account for all points. A one-way ANOVA test shows there are significant differences in delay time for the different airline carriers ($p<<0.05$). Eliminating points greater than 3 standard deviations away from the mean delay for all carriers, we can easily observe differences. Again, a one-way ANOVA test garners the same result, though it is less statistically significant ($p=0.02$). 

```{r arrival delay by airline carrier, cache=TRUE, fig.width=16, fig.height=10}
p1 <- ggplot(group_carrier_ts) +
  geom_boxplot(aes(y=delay_mean_on_given_day, x=reorder(mkt_unique_carrier,delay_mean_on_given_day, mean),
               fill=mkt_unique_carrier)) +
  geom_hline(yintercept = mean(group_carrier_ts$delay_mean_on_given_day), alpha=0.5, col="red", size=1) +
  scale_fill_brewer(palette="Set3") +
  theme(legend.position = "none",
        axis.title = element_text(size=12)) +
  labs(y="Mean delay time per day", x="Airline carrier", title="Mean delay per day by carrier")

#test for differences in carrier delay times
summary(aov(delay_mean_on_given_day ~ mkt_unique_carrier, data=group_carrier_ts))

#test for differences, removing delays more than 3 standard deviations away from the mean delay time
sds <- mean(group_carrier_ts$delay_mean_on_given_day) + (c(-3,3) * sd(group_carrier_ts$delay_mean_on_given_day))
outlier.omit <- group_carrier_ts %>% 
  filter(delay_mean_on_given_day<sds[1] | delay_mean_on_given_day>sds[2])

p2 <- ggplot(outlier.omit) +
  geom_boxplot(aes(y=delay_mean_on_given_day, x=reorder(mkt_unique_carrier,delay_mean_on_given_day, mean),
               fill=mkt_unique_carrier)) +
  geom_hline(yintercept = mean(group_carrier_ts$delay_mean_on_given_day), alpha=0.5, col="red", size=1) +
  scale_fill_brewer(palette="Set3") +
  theme(legend.position = "none",
        axis.title = element_text(size=12)) +
  labs(y="Mean delay time per day", x="Airline carrier", title="Mean delay per day by carrier (delays < 3 SD from mean removed)")

summary(aov(delay_mean_on_given_day ~ mkt_unique_carrier, data=outlier.omit))

p1 | p2
```


<<<<<<< HEAD
# Discussion of Plots

On the plots evaluating Distance, Death, and Origin:
=======
# Discussion of Improvements
>>>>>>> e2554052f6cb7b17b30a7aa48f93dd46db026644

Overall good visualizations, clearly shows the trend between flight delays, origin airports, flight distance, and deaths. 
However, color coding the points in graph "Death vs Delays" and "Distance vs Delays" with states might make the visualization richer in information.  
It may be better to customize the opacity and size of the dots so that it is clearer for readers see each points rather than a black area. 
Probably removing the gaps between bars/dots and x, y axis makes the visualization look better.

One thing we want to improve is the logic behind our visualizations. 
From initial explorations, we are visualizing each of the variables with arrival delay time to find the trend inside the data. 
We divide visualization into sections and have clear logic inside of each section. 
We could explain the relationship between each of the sections and how it goes from the first graph to the last one.

On the plots of Mean Delay, Time, and Airline Carrier:

These are good visualizations. There are many meaningful comparisons between variables, such as mean delay vs time, and mean delay vs airline carrier. The graphs give meaningful insight into these comparisons and show what we are trying to prove well.

Some strong points of these graphs are the clean layout and formatting, easy-to-identify color scheme, and use of appropriate plot types. 

One weak point is hard-to-read text. The axis labels are titles are so small you cannot read them unless you zoom in.

The graphs are very visually appealing and show pertinent information for project.  To improve these plots, we will make the labels and text size easier to read.
